# [Using the Fast JSON API Gem](https://learn.co/tracks/online-software-engineering-structured/front-end-web-programming/rails-as-an-api/using-the-fast-json-api-gem)

## Resources

- [Fast JSON API](https://github.com/Netflix/fast_jsonapi)

## Introduction

We've seen that it is entirely possible to create our own service class
serializers from scratch. This issue is common enough, though, that there are
some popular standardized serializer options available for us to use. In this
lesson, we are going to look at one popular option, the Fast JSON API
gem and use it to create a close approximation to our JSON data from the
previous lessons.

## Introduce the Fast JSON API

The Fast JSON API is a JSON serializer for Rails APIs. It provides a way for us
to generate _serializer_ classes for each resource object in our API that is
involved in customized JSON rendering. We can use these serializer classes to
define the specific attributes we want objects to share or not share, along with
things like related object attributes.

The result is that in our controller actions, rather than writing a custom
`render` each time, we write out a serializer for each object once and use Fast
JSON API to control the way our data is structured.

## Setting up Fast JSON API

To include Fast JSON API, add `gem 'fast_jsonapi'` to your Rails project's Gemfile
and run `bundle install`.

Once installed, you will gain access to a new generator, `serializer`.

## Implementing the Fast JSON API

With the new `serializer` generator, we can create serializer classes for all
three of our models, which will be available to us in any controller actions
later.

```sh
rails g serializer Bird
rails g serializer Location
rails g serializer Sighting
```

Running the above generators will create a `serializers` folder within `/app` and inside the `<model>_serializer.rb` files.

With these serializers, we can start
to define information about each model and their _related_ models we want 
to share in our API.

## Updating the Controller Action

To start using the new serializers, we can update our `render json:` statement
so that it initializes the the newly created `SightingSerializer`, passing in a variable,
just as we did when creating our own service class:

```rb
class SightingsController < ApplicationController
  def show
    sighting = Sighting.find(params[:id])
    render json: SightingSerializer.new(sighting)
  end
end
```

> **ASIDE**: Serializers generated by the Fast JSON API gem have two built-in methods 
> called `serializable_hash` and `serialized_json` which return a serialized hash and a
> JSON string respectively. However, we don't actually need either of these in this example,
> as `to_json` will still be called on `SightingSerializer.new(sighting)` implicitly.
> As we will see, once our serializers are configured and initialized, we will not need  
> to do any additional work

The `SightingSerializer.new(sighting)` statement can be used on _all_ `SightingController` 
actions we want to serialize, so if we were to add an `index`, for instance, we just 
pass in the array of all sightings as well:

```rb
def index
  sightings = Sighting.all
  render json: SightingSerializer.new(sightings)
end
```

## Adding Attributes

When rendering JSON directly, controllers will render all attributes available by
default. These serializers work the other way around - we must always specify
what attributes we _want_ to include. 

```rb
class BirdSerializer
  include FastJsonapi::ObjectSerializer
  attributes :name, :species
end
```

We can also use attributes to access related objects, adding them alongside
normal object attributes:

```rb
class SightingSerializer
  include FastJsonapi::ObjectSerializer
  attributes :created_at, :bird, :location
end
```

However, here, we have no control over what attributes are included in the
related objects, and so we get _all_ the attributes of `"bird"` and
`"location"`.

## Adding Relationships

Object relationships can be included in serializers in two steps. The first step
is that we include the relationships we want to reflect in our serializers. We
can do this in the same way that we include them in the models themselves. A
sighting, for instance, belongs to a bird and a location, so we can update the
serializer to reflect this:

```rb
class SightingSerializer
  include FastJsonapi::ObjectSerializer
  attributes :created_at
  belongs_to :bird
  belongs_to :location
end
```

Fast JSON API will 
display a new `"relationships"` object, but will give only provide limited
information, including the id of the related object:

```js
{
  "id": "2",
  "type": "sighting",
  "attributes": {
    "created_at": "2019-05-14T16:39:37.011Z"
  },
  "relationships": {
    "bird": {
      "data": {
        "id": "2",
        "type": "bird"
      }
    },
    "location": {
      "data": {
        "id": "2",
        "type": "location"
      }
    }
  }
}
```

Setting these relationships up is necessary for the second step. Now that we
have included relationships connecting the `SightingSerializer` to `:bird` and
`:location`, to include attributes from those objects, the recommended method is
to pass in a second _options_ parameter to the serializer indicating that we want to
_include_ those objects:

```rb
def show
  sighting = Sighting.find_by(id: params[:id])
  options = {
    include: [:bird, :location]
  }
  render json: SightingSerializer.new(sighting, options)
end
```

The result:

```js
{
  "data": {
    "id": "2",
    "type": "sighting",
    "attributes": {
      "created_at": "2019-05-14T16:39:37.011Z"
    },
    "relationships": {
      "bird": {
        "data": {
          "id": "2",
          "type": "bird"
        }
      },
      "location": {
        "data": {
          "id": "2",
          "type": "location"
        }
      }
    }
  },
  "included": [{
      "id": "2",
      "type": "bird",
      "attributes": {
        "name": "Grackle",
        "species": "Quiscalus Quiscula"
      }
    },
    {
      "id": "2",
      "type": "location",
      "attributes": {
        "latitude": 30.26715,
        "longitude": -97.74306
      }
    }
  ]
}
```

Because we have a `BirdSerializer` and a `LocationSerializer`, when including
`:bird` and `:location`, Fast JSON API will automatically serialize their
attributes as well.

## Conclusion

There is a lot more you can do with the Fast JSON API gem, and it is worth
reading through their [documentation][contents] to become more familiar with
it. It is possible, for instance, to create entirely custom attributes!

What we covered is enough to get us close to where we were creating our
own customized serializers. We do not get to choose exactly how data gets
serialized the way we do when writing our own serializer classes, but we
gain a lot of flexibility by using the Fast JSON API.

The Fast JSON API gem provides a quick way to generate and customize JSON
serializers with minimal configuration. Its conventions also allow it to work
well even when dealing with a large number of related objects.

[contents]: https://github.com/Netflix/fast_jsonapi#table-of-contents